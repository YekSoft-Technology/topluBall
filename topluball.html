<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopluBall - Multiplayer Football</title>
    <style>
        /* Genel stil ayarları */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c2c2c;
            color: white;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Menü Ekranı */
        .menu-screen {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #2c2c2c;
            position: relative; /* Topluyo.com kutusu için */
        }
        .logo {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            color: #fff;
        }
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
        }
        .menu-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #666;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 220px;
            background-color: #3a3a3a;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .menu-btn:hover {
            transform: translateY(-2px);
            background-color: #4a4a4a;
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .create-room {
            background-color: #4CAF50; /* Yeşil */
            border-color: #4CAF50;
        }
        .join-room {
            background-color: #008CBA; /* Mavi */
            border-color: #008CBA;
        }
        .create-room:hover {
            background-color: #45a049;
        }
        .join-room:hover {
            background-color: #007bb5;
        }

        /* Oda Kurulumu / Odaya Katıl Modalları */
        .room-setup, .waiting-room {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2a2a2a;
            padding: 35px;
            border-radius: 10px;
            border: 1px solid #555;
            min-width: 400px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 100;
        }
        .room-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #666;
            border-radius: 6px;
            background-color: #3a3a3a;
            color: white;
            font-size: 17px;
        }
        .room-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .room-info {
            background-color: #333;
            padding: 18px;
            border-radius: 8px;
            margin: 18px 0;
            border: 1px solid #444;
            font-size: 15px;
        }
        .invite-link {
            background-color: rgba(76, 175, 80, 0.2);
            padding: 10px;
            border-radius: 6px;
            word-break: break-all;
            margin: 10px 0;
            cursor: pointer;
            border: 1px solid #4CAF50;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .invite-link:hover {
            background-color: rgba(76, 175, 80, 0.3);
        }
        .player-slots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .team-column {
            background-color: #3a3a3a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #555;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .team-red {
            border-left: 4px solid #f44;
        }
        .team-blue {
            border-right: 4px solid #44f;
        }
        .player-slot {
            padding: 10px;
            margin: 6px 0;
            border-radius: 8px;
            background-color: #4a4a4a;
            cursor: pointer;
            transition: background 0.1s, border 0.1s;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid transparent;
        }
        .player-slot:hover {
            background-color: #5a5a5a;
        }
        .player-slot.occupied {
            background-color: rgba(76, 175, 80, 0.4);
        }
        .player-slot.current-player {
            background-color: rgba(255, 193, 7, 0.4);
            border: 2px solid #FFC107;
        }
        .player-number {
            font-weight: bold;
            color: #ccc;
            margin-left: 10px;
            font-size: 0.9em;
        }

        /* Oyun Alanı */
        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: none; /* Varsayılan olarak gizli */
            justify-content: center;
            align-items: center;
            background-color: #2c2c2c;
        }
        canvas {
            border: 3px solid #555;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            background-color: #398e41; /* Saha rengi */
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .score-board {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 22px;
            font-weight: bold;
            pointer-events: auto;
            border: 1px solid #777;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .connection-status {
            position: absolute;
            top: 25px;
            right: 25px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            pointer-events: auto;
            font-size: 15px;
            border: 1px solid #777;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        .online-indicator.connected {
            background-color: #4CAF50; /* Yeşil */
        }
        .online-indicator.disconnected {
            background-color: #F44336; /* Kırmızı */
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        .chat-box {
            position: absolute;
            bottom: 25px;
            right: 25px;
            width: 300px;
            height: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid #777;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 12px;
            background-color: #3a3a3a;
            padding: 8px;
            border-radius: 6px;
            line-height: 1.4;
        }
        .chat-input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background-color: #555;
            color: white;
            font-size: 13px;
        }
        .controls {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            pointer-events: auto;
            font-size: 15px;
            border: 1px solid #777;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .leave-btn {
            position: absolute;
            top: 25px;
            left: 25px;
            padding: 10px 18px;
            background-color: #F44336; /* Kırmızı */
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: background-color 0.2s;
        }
        .leave-btn:hover {
            background-color: #d32f2f;
        }
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #4CAF50;
            z-index: 1000;
            display: none;
            box-shadow: 0 0 20px rgba(0,255,0,0.4);
            text-align: center;
            font-size: 18px;
        }
        .notification button {
            margin-top: 15px;
            padding: 8px 20px;
            background-color: #666;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .notification button:hover {
            background-color: #777;
        }
        .copy-btn {
            background-color: #008CBA; /* Mavi */
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #007bb5;
        }

        /* GOAL Animasyonu */
        .goal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        .goal-text {
            font-size: 120px;
            font-weight: extra-bold;
            color: #FFD700; /* Altın rengi */
            text-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 40px rgba(255,215,0,0.6);
            transform: scale(0.5);
            opacity: 0;
            animation: none;
        }
        .goal-overlay.active .goal-text {
            animation: goal-pop 2.5s forwards cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Zıplama efekti */
        }
        @keyframes goal-pop {
            0% { transform: scale(0.5); opacity: 0; }
            30% { transform: scale(1.2); opacity: 1; }
            50% { transform: scale(1); opacity: 1; }
            70% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0; }
        }

        /* Topluyo.com Önizleme Kutusu */
        .topluyo-preview-box {
            position: absolute;
            bottom: 20px; /* Alttan 20px boşluk */
            right: 20px;  /* Sağdan 20px boşluk */
            width: 250px; /* Uzun dikdörtgen */
            height: 100px; /* Biraz yükseklik */
            background-color: #1a1a1a; /* Koyu arka plan */
            border: 2px solid #555; /* Hafif kenarlık */
            border-radius: 8px; /* Köşeleri yuvarlak */
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* Gölge efekti */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            text-align: center;
            z-index: 5; /* Diğer menü elemanlarının üzerinde durmasını sağlar */
        }
        .topluyo-preview-box a {
            color: #4CAF50; /* Yeşil link rengi */
            text-decoration: none; /* Altı çizili olmasın */
            font-weight: bold; /* Kalın yazı */
            font-size: 1.1em; /* Biraz daha büyük yazı */
            transition: color 0.2s; /* Renk geçiş efekti */
        }
        .topluyo-preview-box a:hover {
            color: #66BB6A; /* Üzerine gelince daha açık yeşil */
        }
        .topluyo-preview-box p {
            font-size: 0.9em; /* Küçük yazı */
            color: rgba(255, 255, 255, 0.7); /* Hafif şeffaf beyaz */
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="menu-screen" id="menuScreen">
        <div class="logo">⚽ TopluBall Online</div>
        <div class="menu-buttons">
            <button class="menu-btn create-room" onclick="showCreateRoom()">🏠 Oda Oluştur</button>
            <button class="menu-btn join-room" onclick="showJoinRoom()">🚪 Odaya Katıl</button>
            <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
                Gerçek zamanlı multiplayer futbol oyunu
            </div>
        </div>
        <div class="topluyo-preview-box">
            <p>Bizi diğer platformlarımızda da takip edin!</p>
            <a href="https://topluyo.com" target="_blank">Topluyo.com</a>
        </div>
    </div>

    <div class="room-setup" id="createRoomModal">
        <h2>🏠 Yeni Oda Oluştur</h2>
        <input type="text" class="room-input" id="roomName" placeholder="Oda Adı" maxlength="30">
        <input type="text" class="room-input" id="playerName" placeholder="Oyuncu Adın" maxlength="20">
        <input type="password" class="room-input" id="roomPassword" placeholder="Şifre (İsteğe bağlı)">
        <div style="margin: 20px 0;">
            <label>
                <input type="checkbox" id="publicRoom"> Herkese açık oda
            </label>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="menu-btn" onclick="createRoom()">Oda Oluştur</button>
            <button class="menu-btn" onclick="hideModals()" style="background-color: #666; border-color: #666;">İptal</button>
        </div>
    </div>

    <div class="room-setup" id="joinRoomModal">
        <h2>🚪 Odaya Katıl</h2>
        <input type="text" class="room-input" id="joinRoomId" placeholder="Oda ID veya Davet Linki">
        <input type="text" class="room-input" id="joinPlayerName" placeholder="Oyuncu Adın" maxlength="20">
        <input type="password" class="room-input" id="joinPassword" placeholder="Şifre (Varsa)">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="menu-btn" onclick="joinRoom()">Katıl</button>
            <button class="menu-btn" onclick="hideModals()" style="background-color: #666; border-color: #666;">İptal</button>
        </div>
    </div>

    <div class="waiting-room" id="waitingRoom">
        <h2 id="roomTitle">Oda: Yükleniyor...</h2>
        <div class="room-info">
            <div>Oda ID: <span id="displayRoomId">-</span>
                <button class="copy-btn" onclick="copyInviteLink()">📋 Kopyala</button>
            </div>
            <div class="invite-link" id="inviteLink" onclick="copyInviteLink()">
                Davet linki yükleniyor...
            </div>
            <div>Oyuncular: <span id="currentPlayers">0</span>/4</div>
        </div>

        <div class="player-slots">
            <div class="team-column team-red">
                <h3 style="color: #f44;">🔴 Kırmızı Takım</h3>
                <div class="player-slot" data-team="red" data-slot="0" onclick="joinTeam('red', 0)">
                    <div>Oyuncu 1: Boş</div><span class="player-number"></span>
                </div>
                <div class="player-slot" data-team="red" data-slot="1" onclick="joinTeam('red', 1)">
                    <div>Oyuncu 2: Boş</div><span class="player-number"></span>
                </div>
            </div>
            <div class="team-column team-blue">
                <h3 style="color: #44f;">🔵 Mavi Takım</h3>
                <div class="player-slot" data-team="blue" data-slot="0" onclick="joinTeam('blue', 0)">
                    <div>Oyuncu 3: Boş</div><span class="player-number"></span>
                </div>
                <div class="player-slot" data-team="blue" data-slot="1" onclick="joinTeam('blue', 1)">
                    <div>Oyuncu 4: Boş</div><span class="player-number"></span>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="menu-btn" onclick="startGame()" id="startBtn" disabled>🎮 Oyunu Başlat</button>
            <button class="menu-btn" onclick="leaveRoom()" style="background-color: #F44336; border-color: #F44336;">🚪 Odadan Ayrıl</button>
        </div>
    </div>

    <div class="game-container" id="gameContainer">
        <canvas id="gameCanvas" width="800" height="400"></canvas>

        <div class="ui-overlay">
            <button class="leave-btn" onclick="leaveGame()">← Odaya Dön</button>

            <div class="score-board">
                <span style="color: #f44;">Kırmızı</span>
                <span id="redScore">0</span> - <span id="blueScore">0</span>
                <span style="color: #44f;">Mavi</span>
            </div>
            <div class="connection-status">
                <div class="online-indicator connected" id="connectionIndicator"></div>
                <span id="connectionStatus">Bağlı</span> |
                Ping: <span id="ping">0</span>ms
            </div>
            <div class="controls">
                <strong>Kontroller:</strong> WASD - Hareket (Alternatif Ok Tuşları)| SPACE - Şut/Pas
            </div>
            <div class="chat-box">
                <div class="chat-messages" id="chatMessages"></div>
                <input type="text" class="chat-input" placeholder="Mesaj yaz..." id="chatInput">
            </div>
        </div>
    </div>

    <div class="goal-overlay" id="goalOverlay">
        <div class="goal-text">GOAL!</div>
    </div>

    <div class="notification" id="notification">
        <div id="notificationText">Bildirim</div>
        <button onclick="hideNotification()" style="margin-top: 10px; padding: 5px 15px; background-color: #666; border: none; color: white; border-radius: 5px; cursor: pointer;">Tamam</button>
    </div>

    <script>
      // WebSocket sunucusunun URL'si
const WS_SERVER_URL = 'wss://1d28adfe-0159-46b2-a9a0-9f25bfcf2b8d-00-3gqwvcp4o7ia5.sisko.replit.dev/';
let ws = null; // WebSocket bağlantısını tutacak değişken

// Oyun durumu değişkenleri
let gameState = {
    currentScreen: 'menu',
    isHost: false,
    roomId: null,
    playerId: null,
    playerName: '',
    playerNumber: null, // Oyuncunun atanmış numarası
    currentTeam: null,
    currentSlot: null,
    ball: { x: 400, y: 200, vx: 0, vy: 0, radius: 8 }, // Topun konumu ve hızı
    players: {}, // Tüm oyuncu verileri
    score: { red: 0, blue: 0 }, // Skorlar
    gameStarted: false,
    lastPingTime: 0,
    ping: 0,
    keys: {}, // Yerel oyuncu hareketleri için tuş durumu
    canvas: null,
    ctx: null,
    animationFrameId: null // requestAnimationFrame ID'sini tutmak için
};
let isConnected = false; // Bağlantı durumunu gösteren bayrak

// HTML yüklenince çalışacak kısım
document.addEventListener('DOMContentLoaded', () => {
    gameState.canvas = document.getElementById('gameCanvas');
    gameState.ctx = gameState.canvas.getContext('2d');
    setupInputListeners(); // Tuş dinleyicilerini ayarla
    // URL'den davet kodu kontrolü (Eğer bir davet linkinden gelindiyse)
    const urlParams = new URLSearchParams(window.location.search);
    const inviteRoomId = urlParams.get('room');
    if (inviteRoomId) {
        document.getElementById('joinRoomId').value = inviteRoomId;
        showJoinRoom(); // Doğrudan odaya katıl modalını göster
    }
});

// --- Menü ve Ekran Geçiş Fonksiyonları ---

function showCreateRoom() {
    document.getElementById('createRoomModal').style.display = 'block';
    document.getElementById('playerName').focus(); // Oyuncu adı girişine odaklan
}
function showJoinRoom() {
    document.getElementById('joinRoomModal').style.display = 'block';
    document.getElementById('joinPlayerName').focus(); // Oyuncu adı girişine odaklan
}
function hideModals() {
    document.getElementById('createRoomModal').style.display = 'none';
    document.getElementById('joinRoomModal').style.display = 'none';
}

function showWaitingRoom() {
    document.getElementById('menuScreen').style.display = 'none';
    document.getElementById('waitingRoom').style.display = 'block';
    gameState.currentScreen = 'waiting';
    updateStartButton(); // Bekleme odasına geçince başlat düğmesini güncelle
}

function showGameScreen() {
    document.getElementById('waitingRoom').style.display = 'none';
    document.getElementById('gameContainer').style.display = 'flex';
    gameState.currentScreen = 'game';
}

// --- Oda Yönetimi Fonksiyonları ---

// Yeni oda oluşturma
function createRoom() {
    const roomName = document.getElementById('roomName').value.trim();
    const playerName = document.getElementById('playerName').value.trim();
    const password = document.getElementById('roomPassword').value;
    const isPublic = document.getElementById('publicRoom').checked;

    if (!roomName || !playerName) {
        showNotification('❌ Oda adı ve oyuncu adı boş bırakılamaz!');
        return;
    }
    // WebSocket bağlantısını başlat ve sunucuya oda oluşturma isteği gönder
    connectToServer(roomName, playerName, password, true, isPublic);
    gameState.playerName = playerName;
    gameState.isHost = true;
    hideModals();
    showWaitingRoom();
    showNotification('✅ Oda oluşturuluyor, lütfen bekleyin...');
}

// Mevcut odaya katılma
function joinRoom() {
    const roomId = document.getElementById('joinRoomId').value.trim();
    const playerName = document.getElementById('joinPlayerName').value.trim();
    const password = document.getElementById('joinPassword').value;

    if (!roomId || !playerName) {
        showNotification('❌ Oda ID ve oyuncu adı boş bırakılamaz!');
        return;
    }

    let extractedRoomId = roomId;
    // Eğer tam bir davet linki yapıştırıldıysa, oda ID'sini ayıkla
    if (roomId.includes('room=')) {
        extractedRoomId = roomId.split('room=')[1].split('&')[0];
    }

    // WebSocket bağlantısını başlat ve sunucuya odaya katılma isteği gönder
    connectToServer(extractedRoomId, playerName, password, false);
    gameState.playerName = playerName;
    gameState.isHost = false; // Odaya katılan kişi host olamaz
    hideModals();
    showWaitingRoom();
    showNotification('✅ Odaya bağlanılıyor, lütfen bekleyin...');
}

// Oyunu başlatma (sadece oda sahibi yapabilir)
function startGame() {
    if (!gameState.isHost) {
        showNotification('❌ Oyunu sadece oda sahibi başlatabilir!');
        return;
    }
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('❗ Sunucuya bağlı değilsiniz.');
        return;
    }

    const currentPlayersCount = Object.keys(gameState.players).length;
    if (currentPlayersCount < 2) {
        showNotification('❌ Oyunu başlatmak için en az 2 oyuncu gerekli!');
        return;
    }

    // Sunucuya oyunu başlatma isteği gönder
    ws.send(JSON.stringify({ type: 'startGame', roomId: gameState.roomId }));
}

function leaveGame() { // Oyun içinden bekleme odasına dön
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'leaveGame', roomId: gameState.roomId, playerId: gameState.playerId }));
    }
    document.getElementById('gameContainer').style.display = 'none';
    document.getElementById('waitingRoom').style.display = 'block';
    gameState.currentScreen = 'waiting';
    gameState.gameStarted = false;
    // Oyun döngüsünü durdur
    if (gameState.animationFrameId) {
        cancelAnimationFrame(gameState.animationFrameId);
        gameState.animationFrameId = null;
    }
    updateStartButton(); // Geri dönünce başlat düğmesini tekrar kontrol et
}

function leaveRoom() { // Odadan tamamen ayrıl ve ana menüye dön
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'leaveRoom', roomId: gameState.roomId, playerId: gameState.playerId }));
        ws.close(); // WebSocket bağlantısını kapat
    }
    // Ekranları ve oyun durumunu sıfırla
    document.getElementById('waitingRoom').style.display = 'none';
    document.getElementById('gameContainer').style.display = 'none';
    document.getElementById('menuScreen').style.display = 'flex';
    gameState.currentScreen = 'menu';

    // Oyun durumunu tamamen sıfırla
    gameState.roomId = null;
    gameState.playerId = null;
    gameState.playerName = '';
    gameState.playerNumber = null;
    gameState.players = {};
    gameState.currentTeam = null;
    gameState.currentSlot = null;
    gameState.gameStarted = false;
    ws = null; // WebSocket bağlantısını null yap
    isConnected = false; // Bağlantı durumunu sıfırla
    // Oyun döngüsünü durdur
    if (gameState.animationFrameId) {
        cancelAnimationFrame(gameState.animationFrameId);
        gameState.animationFrameId = null;
    }
    // Input alanlarını temizle
    document.getElementById('roomName').value = '';
    document.getElementById('playerName').value = '';
    document.getElementById('roomPassword').value = '';
    document.getElementById('publicRoom').checked = false;
    document.getElementById('joinRoomId').value = '';
    document.getElementById('joinPlayerName').value = '';
    document.getElementById('joinPassword').value = '';

    // URL'deki oda parametresini temizle
    history.replaceState({}, document.title, window.location.pathname);
}

// Davet linkini kopyala
function copyInviteLink() {
    const inviteLink = document.getElementById('inviteLink').textContent;
    navigator.clipboard.writeText(inviteLink).then(() => {
        showNotification('🔗 Davet linki kopyalandı!');
    }).catch(err => {
        console.error('Davet linki kopyalanamadı:', err);
        showNotification('❌ Davet linki kopyalanamadı.');
    });
}

// --- WebSocket Bağlantı ve Mesaj İşleme ---

function connectToServer(roomOrId, playerName, password, isHost, isPublic = false) {
    if (ws) { // Zaten bir bağlantı varsa eskisini kapat
        ws.close();
    }
    ws = new WebSocket(WS_SERVER_URL);

    ws.onopen = () => {
        console.log('Sunucuya başarıyla bağlandı!');
        isConnected = true;
        // Bağlantı durum göstergesini güncelle
        document.getElementById('connectionIndicator').className = 'online-indicator connected';
        document.getElementById('connectionStatus').textContent = 'Bağlı';

        // Sunucuya ilk mesajı gönder (oda oluşturma veya odaya katılma)
        const message = {
            type: isHost ? 'createRoom' : 'joinRoom',
            roomName: isHost ? roomOrId : undefined, // Sadece oda oluştururken gönder
            roomId: isHost ? undefined : roomOrId,  // Sadece odaya katılırken gönder
            playerName: playerName,
            password: password,
            isPublic: isPublic
        };
        ws.send(JSON.stringify(message));

        // Her saniye ping göndermeye başla
        setInterval(sendPing, 1000);
    };

    ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleServerMessage(message); // Gelen mesajı işle
    };

    ws.onclose = () => {
        console.log('Sunucu bağlantısı kesildi.');
        isConnected = false;
        // Bağlantı durum göstergesini güncelle
        document.getElementById('connectionIndicator').className = 'online-indicator disconnected';
        document.getElementById('connectionStatus').textContent = 'Bağlantı kesildi';
        if (gameState.currentScreen !== 'menu') { // Eğer zaten menüde değilsek bildirim göster
            showNotification('⛔ Sunucu bağlantısı kesildi. Menüye dönülüyor.');
            leaveRoom(); // Bağlantı kesildiğinde menüye dön
        }
    };

    ws.onerror = (error) => {
        console.error('WebSocket hatası:', error);
        showNotification('❌ Bağlantı hatası oluştu. Lütfen tekrar deneyin.');
        if (gameState.currentScreen !== 'menu') { // Eğer zaten menüde değilsek bildirim göster
            leaveRoom(); // Hata durumunda menüye dön
        }
    };
}

// Sunucudan gelen mesajları işleme
function handleServerMessage(message) {
    switch (message.type) {
        case 'roomCreated':
        case 'roomJoined':
            gameState.roomId = message.roomId;
            gameState.playerId = message.playerId;
            gameState.playerNumber = message.playerNumber; // Oyuncunun kendi numarasını kaydet
            document.getElementById('displayRoomId').textContent = gameState.roomId;
            // Davet linkini oluştur ve göster
            document.getElementById('inviteLink').textContent = `${window.location.origin}${window.location.pathname}?room=${gameState.roomId}`;
            document.getElementById('roomTitle').textContent = `Oda: ${message.roomName || message.roomId}`;
            updatePlayerSlots(message.players); // Oyuncu slotlarını güncelle
            showNotification(message.type === 'roomCreated' ? '✅ Oda başarıyla oluşturuldu!' : '✅ Odaya başarıyla katıldınız!');
            break;
        case 'updatePlayers':
            updatePlayerSlots(message.players); // Oyuncu listesi güncellendi
            updateStartButton(); // Oyuncu sayısı değişince başlat düğmesini güncelle
            break;
        case 'chatMessage':
            addChatMessage(message.sender, message.text, message.color); // Sohbet mesajını ekle
            break;
        case 'gameStarted':
            gameState.gameStarted = true;
            showGameScreen();
            initializeGame(); // Oyun döngüsünü başlat
            showNotification('🎮 Oyun başladı!');
            break;
        case 'gameUpdate':
            // Top ve skor bilgilerini güncelle
            gameState.ball = message.ball;
            gameState.score = message.score;

            // Diğer oyuncuların konumlarını sunucudan gelen verilerle güncelle
            for (const id in message.players) {
                // Kendi oyuncumuzun hareketini lokal olarak güncelliyoruz, diğerlerini sunucudan alıyoruz
                // Ancak basitlik için, sunucu tüm pozisyonları gönderiyorsa hepsini güncelleyebiliriz.
                // Bu oyunda sunucu pozisyonlar için yetkilidir.
                gameState.players[id] = { ...gameState.players[id], ...message.players[id] };
            }
            updateScoreBoard(); // Skorbordu güncelle
            break;
        case 'goalScored':
            displayGoal(); // GOAL animasyonunu göster
            // İsteğe bağlı: Gol sesi çal
            break;
        case 'ping':
            // Sunucuya geri 'pong' göndererek ping süresini ölçmesini sağla
            ws.send(JSON.stringify({ type: 'pong', timestamp: message.timestamp }));
            break;
        case 'pong':
            // Ping süresini hesapla ve ekranda göster
            gameState.ping = Date.now() - message.timestamp;
            document.getElementById('ping').textContent = gameState.ping;
            break;
        case 'error':
            showNotification('❗ ' + message.message);
            // Hata durumunda ilgili modal veya odaya dön
            if (gameState.currentScreen === 'waiting') {
                leaveRoom(); // Odadan atıldıysa ana menüye dön
            } else if (gameState.currentScreen === 'game') {
                leaveGame(); // Oyun içindeyken hata gelirse bekleme odasına dön
            }
            break;
    }
}

function sendPing() {
    // Sunucuya ping mesajı gönder
    if (ws && ws.readyState === WebSocket.OPEN) {
        gameState.lastPingTime = Date.now();
        ws.send(JSON.stringify({ type: 'ping', timestamp: gameState.lastPingTime }));
    }
}

// --- Bekleme Odası (Lobby) Fonksiyonları ---

function updatePlayerSlots(playersData) {
    const playerSlots = document.querySelectorAll('.player-slot');
    const currentPlayersElement = document.getElementById('currentPlayers');
    let playerCount = 0;

    // Tüm slotları sıfırla
    playerSlots.forEach(slot => {
        const team = slot.dataset.team;
        const slotNum = parseInt(slot.dataset.slot);
        slot.innerHTML = `<div>Oyuncu ${team === 'red' ? slotNum + 1 : slotNum + 3}: Boş</div><span class="player-number"></span>`;
        slot.classList.remove('occupied', 'current-player');
        // Slot tıklanabilir hale gelsin
        slot.onclick = () => joinTeam(team, slotNum);
    });

    gameState.players = {}; // Mevcut oyuncu listesini temizle

    // Sunucudan gelen oyuncu verilerini doldur
    for (const id in playersData) {
        const player = playersData[id];
        gameState.players[id] = player; // Oyuncu verisini kaydet
        const slotElement = document.querySelector(`.player-slot[data-team="${player.team}"][data-slot="${player.slot}"]`);
        if (slotElement) {
            slotElement.innerHTML = `<div>${player.name}</div><span class="player-number">P${player.playerNumber}</span>`;
            slotElement.classList.add('occupied');
            slotElement.onclick = null; // Dolu slota tıklanmasını engelle
            playerCount++;

            // Mevcut oyuncuyu işaretle
            if (id === gameState.playerId) {
                slotElement.classList.add('current-player');
                gameState.currentTeam = player.team;
                gameState.currentSlot = player.slot;
            }
        }
    }
    currentPlayersElement.textContent = playerCount;
    updateStartButton(); // Oyuncu slotları güncellendiğinde başlat düğmesini tekrar kontrol et
}

function joinTeam(team, slot) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        showNotification('❗ Sunucuya bağlı değilsiniz.');
        return;
    }

    // Zaten bu slottaysak bir şey yapma
    if (gameState.currentTeam === team && gameState.currentSlot === slot) {
        showNotification('ℹ️ Zaten bu slottasınız.');
        return;
    }

    // Dolu mu kontrol et
    const slotElement = document.querySelector(`.player-slot[data-team="${team}"][data-slot="${slot}"]`);
    if (slotElement && slotElement.classList.contains('occupied')) {
        showNotification('❌ Bu slot dolu! Başka bir slot seçin.');
        return;
    }

    // Sunucuya slota katılma isteği gönder
    ws.send(JSON.stringify({ type: 'joinSlot', roomId: gameState.roomId, playerId: gameState.playerId, team: team, slot: slot }));
    showNotification(`✅ ${team === 'red' ? 'Kırmızı' : 'Mavi'} takımına, ${slot + 1}. slota katılma isteği gönderildi.`);
}

function updateStartButton() {
    const startBtn = document.getElementById('startBtn');
    // Başlat düğmesi sadece oda sahibi ise VE en az 2 oyuncu varsa aktif olur
    const currentPlayersCount = Object.keys(gameState.players).length;
    startBtn.disabled = !gameState.isHost || currentPlayersCount < 2;

    if (startBtn.disabled) {
        if (!gameState.isHost) {
            startBtn.textContent = 'Oyunu Başlat (Sadece Oda Sahibi)';
        } else if (currentPlayersCount < 2) {
            startBtn.textContent = `Oyunu Başlat (${currentPlayersCount}/2 Oyuncu)`;
        }
    } else {
        startBtn.textContent = '🎮 Oyunu Başlat';
    }
}


// --- Oyun Alanı (Canvas) Çizim Fonksiyonları ---

function initializeGame() {
    if (gameState.gameStarted) {
        gameLoop(); // Oyun döngüsünü başlat
    }
}

function gameLoop() {
    drawBackground();
    drawField();
    drawBall();
    drawPlayers();

    if (gameState.gameStarted) {
        // Her karede kendi oyuncumuzun hareketini sunucuya gönder
        sendPlayerMovement();
        gameState.animationFrameId = requestAnimationFrame(gameLoop);
    }
}

function drawBackground() {
    gameState.ctx.fillStyle = '#398e41'; // Saha rengi
    gameState.ctx.fillRect(0, 0, gameState.canvas.width, gameState.canvas.height);
}

function drawField() {
    const ctx = gameState.ctx;
    const canvas = gameState.canvas;

    // Ortadaki çizgi
    ctx.beginPath();
    ctx.moveTo(canvas.width / 2, 0);
    ctx.lineTo(canvas.width / 2, canvas.height);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Orta yuvarlak
    ctx.beginPath();
    ctx.arc(canvas.width / 2, canvas.height / 2, 70, 0, Math.PI * 2);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Kale alanları
    // Sol Kale Alanı
    ctx.beginPath();
    ctx.rect(0, canvas.height / 2 - 90, 80, 180);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Sağ Kale Alanı
    ctx.beginPath();
    ctx.rect(canvas.width - 80, canvas.height / 2 - 90, 80, 180);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Kaleler (Daha kalın çizgiler)
    // Sol Kale
    ctx.beginPath();
    ctx.rect(0, canvas.height / 2 - 40, 20, 80);
    ctx.strokeStyle = '#F44336'; // Kırmızı kale
    ctx.lineWidth = 3;
    ctx.stroke();

    // Sağ Kale
    ctx.beginPath();
    ctx.rect(canvas.width - 20, canvas.height / 2 - 40, 20, 80);
    ctx.strokeStyle = '#2196F3'; // Mavi kale
    ctx.lineWidth = 3;
    ctx.stroke();
}

function drawBall() {
    const ctx = gameState.ctx;
    const ball = gameState.ball;
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
    ctx.fillStyle = 'white';
    ctx.shadowColor = 'rgba(255, 255, 255, 0.7)';
    ctx.shadowBlur = 10;
    ctx.fill();
    ctx.shadowBlur = 0; // Gölgeyi sıfırla
}

function drawPlayers() {
    const ctx = gameState.ctx;
    for (const id in gameState.players) {
        const player = gameState.players[id];
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
        ctx.fillStyle = player.team === 'red' ? 'red' : 'blue';
        ctx.shadowColor = player.team === 'red' ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 0, 255, 0.7)';
        ctx.shadowBlur = 10;
        ctx.fill();
        ctx.shadowBlur = 0; // Gölgeyi sıfırla

        // Oyuncu adı
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(player.name, player.x, player.y - player.radius - 5);
    }
}

function updateScoreBoard() {
    document.getElementById('redScore').textContent = gameState.score.red;
    document.getElementById('blueScore').textContent = gameState.score.blue;
}

// --- Klavye Girişleri ve Oyuncu Hareketi ---

function setupInputListeners() {
    document.addEventListener('keydown', (e) => {
        if (gameState.currentScreen === 'game' && !document.getElementById('chatInput').matches(':focus')) {
            gameState.keys[e.key.toLowerCase()] = true;
            sendPlayerMovement(); // Her tuş basımında hareketi gönder
        } else if (e.key === 'Enter' && document.getElementById('chatInput').matches(':focus')) {
            sendChatMessage();
        }
    });

    document.addEventListener('keyup', (e) => {
        if (gameState.currentScreen === 'game' && !document.getElementById('chatInput').matches(':focus')) {
            gameState.keys[e.key.toLowerCase()] = false;
            sendPlayerMovement(); // Her tuş bırakmada hareketi gönder
        }
    });

    // Sohbet kutusu için Enter tuşu
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
}

function sendPlayerMovement() {
    if (!ws || ws.readyState !== WebSocket.OPEN || !gameState.gameStarted || !gameState.playerId) {
        return;
    }

    // Gönderilecek hareket verilerini oluştur
    const movementData = {
        up: gameState.keys['w'] || gameState.keys['arrowup'],
        down: gameState.keys['s'] || gameState.keys['arrowdown'],
        left: gameState.keys['a'] || gameState.keys['arrowleft'],
        right: gameState.keys['d'] || gameState.keys['arrowright'],
        action: gameState.keys[' '] // Boşluk tuşu (şut/pas)
    };

    // Sunucuya oyuncu hareketini gönder
    ws.send(JSON.stringify({
        type: 'playerMove',
        roomId: gameState.roomId,
        playerId: gameState.playerId,
        movement: movementData
    }));
}

// --- Sohbet Fonksiyonları ---

function addChatMessage(sender, text, color = 'white') {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.innerHTML = `<strong style="color: ${color};">${sender}:</strong> ${text}`;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight; // En alta kaydır
}

function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    const messageText = chatInput.value.trim();
    if (messageText && ws && ws.readyState === WebSocket.OPEN && gameState.roomId) {
        ws.send(JSON.stringify({
            type: 'chatMessage',
            roomId: gameState.roomId,
            playerId: gameState.playerId,
            message: messageText
        }));
        chatInput.value = ''; // Mesajı gönderdikten sonra input'u temizle
    }
}

// --- Bildirim ve Animasyon Fonksiyonları ---

function showNotification(message, duration = 3000) {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    notificationText.textContent = message;
    notification.style.display = 'block';
    // Otomatik olarak gizle
    setTimeout(() => {
        hideNotification();
    }, duration);
}

function hideNotification() {
    document.getElementById('notification').style.display = 'none';
}

function displayGoal() {
    const goalOverlay = document.getElementById('goalOverlay');
    const goalText = document.querySelector('.goal-text');

    goalOverlay.style.opacity = 1;
    goalText.style.animation = 'none'; // Animasyonu sıfırla
    void goalText.offsetWidth; // Reflow'u tetikle
    goalText.style.animation = ''; // Animasyonu tekrar başlat
    goalOverlay.classList.add('active');

    setTimeout(() => {
        goalOverlay.style.opacity = 0;
        goalOverlay.classList.remove('active');
    }, 2500); // Animasyon süresi kadar bekle
}
    </script>
</body>
</html>
